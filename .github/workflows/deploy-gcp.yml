name: Build & Deploy to GCP VM

on:
  push:
    branches: [main]
  workflow_dispatch:

# ── GitHub Secrets necessários ──────────────────────────────────────────────
# VM_SSH_KEY          → chave privada SSH (conteúdo de ~/.ssh/google_compute_engine)
# VM_HOST             → IP da VM (34.56.82.116)
# VM_USER             → user SSH (web2a)
# ────────────────────────────────────────────────────────────────────────────

jobs:
  deploy:
    name: Build & Deploy (native binary)
    runs-on: ubuntu-latest
    # Só deploya se o CI passou (lint+test no ci.yml)
    needs: []

    steps:
      - name: SSH → git pull + cargo build + restart
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            echo "=== Git pull ==="
            cd /opt/NietzscheDB
            git fetch origin main
            git reset --hard origin/main
            echo "Commit: $(git log --oneline -1)"

            echo "=== Cargo build (release) ==="
            source "$HOME/.cargo/env" 2>/dev/null || true
            cargo build --release 2>&1 | tail -20

            echo "=== Deploy binary ==="
            sudo systemctl stop nietzsche-server || true
            sudo cp target/release/nietzsche-server /usr/local/bin/nietzsche-server
            sudo systemctl start nietzsche-server

            echo "=== Aguardando 5s ==="
            sleep 5

            echo "=== Health check ==="
            if curl -sf --max-time 10 http://localhost:8080/api/health; then
              echo ""
              echo "Deploy OK!"
            else
              echo "WARN: health check falhou (servidor pode estar carregando collections)"
              sudo systemctl status nietzsche-server --no-pager | head -15
            fi

  notify:
    name: Email Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ needs.deploy.result == 'failure' && '❌' || '✅' }} Deploy NietzscheDB - ${{ github.ref_name }}"
          to: petweofc@gmail.com,web2ajax@gmail.com
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Workflow: ${{ github.workflow }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Status: ${{ needs.deploy.result }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
